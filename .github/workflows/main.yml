name: Deploy Tailscale RDP

on:
  workflow_dispatch:  # Manual trigger
  schedule:
    - cron: '0 */6 * * *'  # Run every 6 hours untuk menjaga sesi aktif

jobs:
  build:
    runs-on: windows-latest  # Menggunakan Windows runner untuk RDP
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Tailscale
      shell: powershell
      run: |
        # Download dan install Tailscale
        Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe" -OutFile "tailscale-setup.exe"
        Start-Process -FilePath "tailscale-setup.exe" -ArgumentList "/S" -Wait
        
        # Start Tailscale service
        Start-Service -Name "Tailscale"
        
        # Connect to Tailscale menggunakan auth key
        $Env:TAILSCALE_AUTHKEY = "${{ secrets.TAILSCALE_AUTHKEY }}"
        & "C:\Program Files\Tailscale\tailscale.exe" up --authkey $Env:TAILSCALE_AUTHKEY --hostname "github-rdp-${{ github.run_id }}"
        
        # Dapatkan IP Tailscale
        $tailscaleIP = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
        echo "TAILSCALE_IP=$tailscaleIP" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append
        echo "RDP Address: $tailscaleIP"
        
    - name: Configure RDP
      shell: powershell
      run: |
        # Enable RDP
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        
        # Configure firewall
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        
        # Set password untuk user Administrator (opsional)
        # HATI-HATI: Ini hanya untuk testing, jangan gunakan di production
        $password = ConvertTo-SecureString "Password123" -AsPlainText -Force
        Set-LocalUser -Name "runneradmin" -Password $password -ErrorAction SilentlyContinue
        
        # Allow RDP through Tailscale
        New-NetFirewallRule -DisplayName "Tailscale RDP" -Direction Inbound -Protocol TCP -LocalPort 3389 -Action Allow
        
    - name: Display Connection Info
      shell: powershell
      run: |
        echo "=========================================="
        echo "RDP CONNECTION INFORMATION:"
        echo "=========================================="
        echo "Tailscale IP: $Env:TAILSCALE_IP"
        echo "Username: runneradmin"
        echo "Password: Password123"
        echo "=========================================="
        echo "Connect using: mstsc /v:$Env:TAILSCALE_IP"
        echo "=========================================="
        
        # Simpan info ke file
        $connectionInfo = @"
        ==========================================
        RDP CONNECTION INFORMATION:
        ==========================================
        Tailscale IP: $Env:TAILSCALE_IP
        Username: runneradmin
        Password: Password123
        ==========================================
        Connect using: mstsc /v:$Env:TAILSCALE_IP
        ==========================================
        "@
        
        Set-Content -Path "connection-info.txt" -Value $connectionInfo
        
    - name: Keep RDP Session Alive
      shell: powershell
      run: |
        # Script untuk menjaga sesi tetap hidup
        $keepAliveScript = @"
        while (`$true) {
            Write-Host "RDP Session Active - $(Get-Date)"
            Start-Sleep -Seconds 300  # Setiap 5 menit
        }
        "@
        
        Set-Content -Path "keep-alive.ps1" -Value $keepAliveScript
        
        # Jalankan script di background
        Start-Process powershell -ArgumentList "-File keep-alive.ps1" -WindowStyle Hidden
        
    - name: Upload Connection Info
      uses: actions/upload-artifact@v4
      with:
        name: rdp-connection-info
        path: connection-info.txt
